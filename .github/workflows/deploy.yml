name: Deploy Frontend, Admin & Backend

on:
  push:
    branches: ["dev"]
  workflow_dispatch:

env:
  DEPLOY_PATH: /var/www/single-ecom

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # -------------------- CHECKOUT --------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------- NODE SETUP --------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: npm
        cache-dependency-path: |
          frontend/package-lock.json
          admin/package-lock.json

    # -------------------- BUILD FRONTEND --------------------
    - name: Install Frontend deps
      working-directory: frontend
      run: npm ci

    - name: Build Frontend
      working-directory: frontend
      env:
        VITE_API_URL: ${{ secrets.VITE_API_URL }}
      run: npm run build

    # -------------------- BUILD ADMIN --------------------
    - name: Install Admin deps
      working-directory: admin
      run: npm ci

    - name: Build Admin
      working-directory: admin
      env:
        API_URL: ${{ secrets.VITE_API_URL }}
      run: npm run build

    # -------------------- SSH SETUP --------------------
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

    # -------------------- DEPLOY FRONTEND --------------------
    - name: Deploy Frontend build
      run: |
        rsync -az --delete \
          frontend/.output/ \
          ${{ secrets.USERNAME }}@${{ secrets.HOST }}:${{ env.DEPLOY_PATH }}/frontend/.output/

    # -------------------- DEPLOY ADMIN --------------------
    - name: Deploy Admin build
      run: |
        rsync -az --delete \
          admin/.output/ \
          ${{ secrets.USERNAME }}@${{ secrets.HOST }}:${{ env.DEPLOY_PATH }}/admin/.output/

    # -------------------- DEPLOY BACKEND CODE --------------------
    - name: Deploy Backend code
      run: |
        rsync -az --delete \
          --exclude=venv \
          backend/ \
          ${{ secrets.USERNAME }}@${{ secrets.HOST }}:${{ env.DEPLOY_PATH }}/backend/

    # -------------------- FINALIZE ON SERVER --------------------
    - name: Configure env, migrate DB, restart services
      run: |
        ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
        set -e

        BASE="${{ env.DEPLOY_PATH }}"

        echo "üîê Writing backend .env"
        install -m 600 /dev/null $BASE/backend/.env
        cat << 'ENVEOF' > $BASE/backend/.env
        ${{ secrets.BACKEND_ENV }}
        ENVEOF

        echo "üì¶ Sync backend dependencies"
        cd $BASE/backend
        uv sync --frozen --no-install-project

        echo "üóÑÔ∏è Running database migrations"
        uv run alembic upgrade head

        echo "üîÑ Restarting services"
        sudo systemctl restart single-ecom-backend.service
        sudo systemctl restart single-ecom-frontend.service
        sudo systemctl restart single-ecom-admin.service

        echo "‚úÖ Deployment complete"
        EOF
